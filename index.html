<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inecta Discovery Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@700&family=Verdana&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Official Inecta Brand Colors */
      --inecta-green: #124030;
      --inecta-teal: #00CCCC;
      --inecta-yellow: #FFD44D;
      --inecta-tan: #DECF9E;
      --dark-grey: #575763;
      --light-grey: #999999;
      
      /* UI Theme Colors */
      --background-light: #F8F8F8;
      --border-color: #EAEAEA;
      --body-text-color: #293036;
      --bot-bubble-bg: #FFFFFF;
      --user-bubble-bg: var(--inecta-green);

      /* Typography from Brand Guide */
      --font-heading: 'Open Sans', sans-serif;
      --font-body: 'Verdana', sans-serif;
    }
    body {
      font-family: var(--font-body);
      background: var(--background-light);
      color: var(--body-text-color);
      padding: 20px;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      box-sizing: border-box;
    }
    .container {
      width: 100%;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      height: 100%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      border-radius: 16px;
      overflow: hidden;
      background: #FFFFFF;
      transition: filter 0.3s ease;
    }
    .container.blurred {
      filter: blur(3px);
      pointer-events: none;
    }
    .header {
      padding: 15px 20px;
      background: #FFFFFF;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header img {
      height: 28px;
      width: auto;
    }
    #newChatBtn {
      padding: 6px 12px;
      font-size: 12px;
      font-family: var(--font-heading);
      font-weight: 700;
      background-color: var(--light-grey);
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    #newChatBtn:hover {
      background-color: var(--dark-grey);
    }
    .topic-tracker { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 8px; 
      padding: 15px 20px;
      justify-content: center;
      border-bottom: 1px solid var(--border-color);
    }
    .topic-item { 
      padding: 6px 12px; 
      border-radius: 15px; 
      font-size: 12px; 
      font-family: var(--font-heading);
      font-weight: 700;
      transition: all 0.3s ease; 
      border: 1px solid transparent; 
    }
    .status-not-started { background-color: #E0E0E0; color: #616161; }
    .status-in-progress { background-color: var(--inecta-tan); color: var(--inecta-green); animation: pulse-tan 2s infinite; }
    .status-completed { background-color: var(--inecta-green); color: #FFFFFF; }
    @keyframes pulse-tan {
      0% { box-shadow: 0 0 0 0 rgba(222, 207, 158, 0.7); }
      70% { box-shadow: 0 0 0 8px rgba(222, 207, 158, 0); }
      100% { box-shadow: 0 0 0 0 rgba(222, 207, 158, 0); }
    }
    .chat {
      padding: 30px;
      flex-grow: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      background-color: var(--background-light);
    }
    .chat::-webkit-scrollbar { width: 8px; }
    .chat::-webkit-scrollbar-track { background: var(--background-light); border-radius: 4px; }
    .chat::-webkit-scrollbar-thumb { background-color: #d4d4d4; border-radius: 4px; }
    .chat::-webkit-scrollbar-thumb:hover { background-color: var(--dark-grey); }
    .msg {
      padding: 12px 18px;
      border-radius: 20px;
      line-height: 1.6;
      max-width: 80%;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .user {
      background-color: var(--user-bubble-bg);
      color: #FFFFFF;
      border-bottom-right-radius: 5px;
      align-self: flex-end;
    }
    .bot {
      background-color: var(--bot-bubble-bg);
      color: var(--body-text-color);
      border: 1px solid var(--border-color);
      border-bottom-left-radius: 5px;
      align-self: flex-start;
    }
    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 12px 18px;
    }
    .typing-indicator span {
      height: 8px; width: 8px; background-color: #BDBDBD;
      border-radius: 50%; display: inline-block; margin: 0 2px;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    .typing-indicator span:nth-of-type(2) { animation-delay: -0.2s; }
    .typing-indicator span:nth-of-type(3) { animation-delay: -0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1.0); }
    }
    .input-container {
        padding: 20px;
        border-top: 1px solid var(--border-color);
        background: #FFFFFF;
    }
    .input-area {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #attachmentDisplay {
      font-size: 12px;
      font-style: italic;
      margin-bottom: 8px;
      padding: 5px 10px;
      background-color: #f0f0f0;
      border-radius: 12px;
      display: none;
    }
    #messageInput {
      flex-grow: 1;
      padding: 12px 18px;
      border-radius: 22px;
      border: 1px solid var(--border-color);
      background: var(--background-light);
      color: var(--body-text-color);
      font-size: 16px;
      font-family: var(--font-body);
    }
    #messageInput:focus {
        outline: none;
        border-color: var(--inecta-teal);
        box-shadow: 0 0 0 2px rgba(0, 204, 204, 0.2);
    }
    #sendButton, #uploadButton {
      background-color: var(--inecta-teal);
      color: #000000;
      border: none;
      cursor: pointer;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    #reportButton, #scheduleButton {
      padding: 10px 20px;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      font-family: var(--font-heading);
      font-weight: 700;
      text-transform: uppercase;
      transition: all 0.2s ease;
      font-size: 16px;
      white-space: nowrap;
      background-color: var(--inecta-green);
      color: #FFFFFF;
      display: none;
      flex-grow: 1;
    }
    #sendButton:disabled, #uploadButton:disabled {
      background-color: #BDBDBD;
      cursor: not-allowed;
    }
    #sendButton:hover:not(:disabled), #uploadButton:hover:not(:disabled), #reportButton:hover:not(:disabled), #scheduleButton:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Modal Overlay Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    .modal-overlay.show {
      display: flex;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
      text-align: center;
    }
    .modal-logo {
      height: 32px;
      margin-bottom: 16px;
    }
    .modal-header h2 {
      margin: 0;
      color: var(--inecta-green);
      font-family: var(--font-heading);
      font-size: 24px;
    }
    .modal-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }
    .legal-text {
      color: var(--body-text-color);
      line-height: 1.6;
      font-size: 14px;
    }
    .legal-text h3 {
      color: var(--inecta-green);
      margin-top: 20px;
      margin-bottom: 12px;
      font-size: 18px;
    }
    .legal-text h4 {
      color: var(--dark-grey);
      margin-top: 16px;
      margin-bottom: 8px;
      font-size: 16px;
    }
    .legal-text p {
      margin-bottom: 12px;
    }
    .modal-content::-webkit-scrollbar {
      width: 8px;
    }
    .modal-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    .modal-content::-webkit-scrollbar-thumb {
      background: var(--light-grey);
      border-radius: 4px;
    }
    .modal-content::-webkit-scrollbar-thumb:hover {
      background: var(--dark-grey);
    }
    .modal-footer {
      padding: 24px;
      border-top: 1px solid var(--border-color);
      background: #f9f9f9;
      border-radius: 0 0 16px 16px;
    }
    .consent-container {
      margin-bottom: 20px;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .checkbox-container input {
      display: none;
    }
    .checkmark {
      width: 20px;
      height: 20px;
      border: 2px solid var(--inecta-green);
      border-radius: 4px;
      margin-right: 12px;
      position: relative;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    .checkbox-container input:checked ~ .checkmark {
      background-color: var(--inecta-green);
    }
    .checkmark:after {
      content: "";
      position: absolute;
      display: none;
      left: 6px;
      top: 2px;
      width: 5px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }
    .checkbox-container input:checked ~ .checkmark:after {
      display: block;
    }
    .consent-text {
      color: var(--body-text-color);
      font-size: 14px;
    }
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .btn-primary, .btn-secondary {
      padding: 12px 32px;
      border-radius: 24px;
      font-family: var(--font-heading);
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      text-transform: uppercase;
    }
    .btn-primary {
      background-color: var(--inecta-teal);
      color: black;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 204, 204, 0.3);
    }
    .btn-primary:disabled {
      background-color: #d0d0d0;
      color: #888;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .btn-secondary {
      background-color: transparent;
      color: var(--dark-grey);
      border: 2px solid var(--dark-grey);
    }
    .btn-secondary:hover {
      background-color: var(--dark-grey);
      color: white;
    }
    .timestamp-notice {
      margin-top: 16px;
      text-align: center;
      color: var(--light-grey);
      font-size: 11px;
    }
    .modal-reminder {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--inecta-yellow);
      color: var(--inecta-green);
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 10000;
      animation: slideDown 0.3s ease;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    @media (max-width: 768px) {
      .modal-container {
        width: 95%;
        max-height: 90vh;
        margin: 20px;
      }
      .modal-actions {
        flex-direction: column;
      }
      .btn-primary, .btn-secondary {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <!-- Legal Agreement Modal -->
  <div id="legalModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhLS0gQ3JlYXRlZCB3aXRoIElua3NjYXBlIChodHRwOi8vd3d3Lmlua3NjYXBlLm9yZy8pIC0tPgoKPHN2ZwogICB2ZXJzaW9uPSIxLjEiCiAgIGlkPSJzdmcyIgogICB3aWR0aD0iNjM1Ljc5OTk5IgogICBoZWlnaHQ9IjE0MC4yOTMzMyIKICAgdmlld0JveD0iMCAwIDYzNS43OTk5OSAxNDAuMjkzMzMiCiAgIHNvZGlwb2RpOmRvY25hbWU9IklORUNUQV9MT0dPX1BSSU1BUlkuZXBzIgogICB4bWxuczppbmtzY2FwZT0iaHR0cDovL3d3dy5pbmtzY2FwZS5vcmcvbmFtZXNwYWNlcy9pbmtzY2FwZSIKICAgeG1sbnM6c29kaXBvZGk9Imh0dHA6Ly9zb2RpcG9kaS5zb3VyY2Vmb3JnZS5uZXQvRFREL3NvZGlwb2RpLTAuZHRkIgogICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxkZWZzCiAgICAgaWQ9ImRlZnM2IiAvPgogIDxzb2RpcG9kaTpuYW1lZHZpZXcKICAgICBpZD0ibmFtZWR2aWV3NCIKICAgICBwYWdlY29sb3I9IiNmZmZmZmYiCiAgICAgYm9yZGVyY29sb3I9IiMwMDAwMDAiCiAgICAgYm9yZGVyb3BhY2l0eT0iMC4yNSIKICAgICBpbmtzY2FwZTpzaG93cGFnZXNoYWRvdz0iMiIKICAgICBpbmtzY2FwZTpwYWdlb3BhY2l0eT0iMC4wIgogICAgIGlua3NjYXBlOnBhZ2VjaGVja2VyYm9hcmQ9IjAiCiAgICAgaW5rc2NhcGU6ZGVza2NvbG9yPSIjZDFkMWQxIiAvPgogIDxnCiAgICAgaWQ9Imc4IgogICAgIGlua3NjYXBlOmdyb3VwbW9kZT0ibGF5ZXIiCiAgICAgaW5rc2NhcGU6bGFiZWw9Imlua19leHRfWFhYWFhYIgogICAgIHRyYW5zZm9ybT0ibWF0cml4KDEuMzMzMzMzMywwLDAsLTEuMzMzMzMzMywwLDE0MC4yOTMzMykiPgogICAgPGcKICAgICAgIGlkPSJnMTAiCiAgICAgICB0cmFuc2Zvcm09InNjYWxlKDAuMSkiPgogICAgICA8cGF0aAogICAgICAgICBkPSJNIDk4OS41OTgsNzcyLjY2NCBIIDExOTIuNTUgViAyMi44Nzg5IEggOTg5LjU5OCBWIDc3My42NjQiCiAgICAgICAgIHN0eWxlPSJmaWxsOiMxZjQ5M2E7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmUiCiAgICAgICAgIGlkPSJwYXRoMTIiIC8+CiAgICA8L2c+CiAgPC9nPgo8L3N2Zz4=" 
        alt="Inecta Logo" class="modal-logo">
        <h2>Terms of Use & Privacy Policy</h2>
      </div>
      
      <div class="modal-content">
        <div class="legal-text">
          <h3>Terms of Service</h3>
          <p>By using the Inecta Discovery Assistant, you agree to the following terms:</p>
          
          <h4>1. Data Collection and Use</h4>
          <p>We collect and process business information you provide to deliver customized ERP/manufacturing software recommendations. This includes company details, operational data, and any documents you upload.</p>
          
          <h4>2. Confidentiality</h4>
          <p>All information shared during this discovery process will be treated as confidential and used solely for the purpose of providing business analysis and recommendations.</p>
          
          <h4>3. Data Security</h4>
          <p>We implement industry-standard security measures to protect your information. Data is encrypted in transit and at rest.</p>
          
          <h4>4. Document Upload</h4>
          <p>By uploading documents, you confirm you have the right to share this information and that it does not violate any third-party rights or confidentiality agreements.</p>
          
          <h4>5. AI-Generated Content</h4>
          <p>The Discovery Assistant uses artificial intelligence to analyze your requirements. While we strive for accuracy, recommendations should be reviewed and validated by your team.</p>
          
          <h3>Privacy Notice</h3>
          <p>Your privacy is important to us. This notice explains how we handle your data:</p>
          
          <h4>Information We Collect</h4>
          <p>We collect information you provide directly, including company information, business requirements, and uploaded documents. We also collect technical data such as IP addresses and session identifiers for security and service improvement.</p>
          
          <h4>Data Retention</h4>
          <p>Your session data will be retained for 90 days to allow for follow-up and report generation. After this period, data is automatically deleted unless you request extended retention for ongoing projects.</p>
          
          <h4>Your Rights</h4>
          <p>You have the right to access, correct, or delete your personal information. You may also request a copy of your data or restrict its processing.</p>
          
          <h4>Contact Information</h4>
          <p>For questions about these terms or your data, contact us at:</p>
          <p>Email: privacy@inecta.com<br>
          Phone: 1-800-INECTA-1<br>
          Address: Inecta Corporation, 123 Business Way, Suite 100, Tech City, TC 12345</p>
        </div>
      </div>
      
      <div class="modal-footer">
        <div class="consent-container">
          <label class="checkbox-container">
            <input type="checkbox" id="consentCheckbox">
            <span class="checkmark"></span>
            <span class="consent-text">I have read and agree to the Terms of Service and Privacy Policy</span>
          </label>
        </div>
        
        <div class="modal-actions">
          <button id="declineBtn" class="btn-secondary">Decline</button>
          <button id="acceptBtn" class="btn-primary" disabled>I Agree</button>
        </div>
        
        <div class="timestamp-notice">
          <small>Your agreement will be recorded with timestamp and IP address for compliance purposes.</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Chat Container -->
  <div class="container">
    <div class="header">
      <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhLS0gQ3JlYXRlZCB3aXRoIElua3NjYXBlIChodHRwOi8vd3d3Lmlua3NjYXBlLm9yZy8pIC0tPgoKPHN2ZwogICB2ZXJzaW9uPSIxLjEiCiAgIGlkPSJzdmcyIgogICB3aWR0aD0iNjM1Ljc5OTk5IgogICBoZWlnaHQ9IjE0MC4yOTMzMyIKICAgdmlld0JveD0iMCAwIDYzNS43OTk5OSAxNDAuMjkzMzMiCiAgIHNvZGlwb2RpOmRvY25hbWU9IklORUNUQV9MT0dPX1BSSU1BUlkuZXBzIgogICB4bWxuczppbmtzY2FwZT0iaHR0cDovL3d3dy5pbmtzY2FwZS5vcmcvbmFtZXNwYWNlcy9pbmtzY2FwZSIKICAgeG1sbnM6c29kaXBvZGk9Imh0dHA6Ly9zb2RpcG9kaS5zb3VyY2Vmb3JnZS5uZXQvRFREL3NvZGlwb2RpLTAuZHRkIgogICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxkZWZzCiAgICAgaWQ9ImRlZnM2IiAvPgogIDxzb2RpcG9kaTpuYW1lZHZpZXcKICAgICBpZD0ibmFtZWR2aWV3NCIKICAgICBwYWdlY29sb3I9IiNmZmZmZmYiCiAgICAgYm9yZGVyY29sb3I9IiMwMDAwMDAiCiAgICAgYm9yZGVyb3BhY2l0eT0iMC4yNSIKICAgICBpbmtzY2FwZTpzaG93cGFnZXNoYWRvdz0iMiIKICAgICBpbmtzY2FwZTpwYWdlb3BhY2l0eT0iMC4wIgogICAgIGlua3NjYXBlOnBhZ2VjaGVja2VyYm9hcmQ9IjAiCiAgICAgaW5rc2NhcGU6ZGVza2NvbG9yPSIjZDFkMWQxIiAvPgogIDxnCiAgICAgaWQ9Imc4IgogICAgIGlua3NjYXBlOmdyb3VwbW9kZT0ibGF5ZXIiCiAgICAgaW5rc2NhcGU6bGFiZWw9Imlua19leHRfWFhYWFhYIgogICAgIHRyYW5zZm9ybT0ibWF0cml4KDEuMzMzMzMzMywwLDAsLTEuMzMzMzMzMywwLDE0MC4yOTMzMykiPgogICAgPGcKICAgICAgIGlkPSJnMTAiCiAgICAgICB0cmFuc2Zvcm09InNjYWxlKDAuMSkiPgogICAgICA8cGF0aAogICAgICAgICBkPSJNIDk4OS41OTgsNzcyLjY2NCBIIDExOTIuNTUgViAyMi44Nzg5IEggOTg5LjU5OCBWIDc3My42NjQiCiAgICAgICAgIHN0eWxlPSJmaWxsOiMxZjQ5M2E7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmUiCiAgICAgICAgIGlkPSJwYXRoMTIiIC8+CiAgICA8L2c+CiAgPC9nPgo8L3N2Zz4="
      alt="Inecta Logo">
      <button id="newChatBtn" title="Start a new conversation">New Chat</button>
    </div>
    <div id="topicTracker" class="topic-tracker"></div>
    <div id="chat" class="chat"></div>
    <div class="input-container">
        <div id="attachmentDisplay"></div>
        <div class="input-area">
            <input id="messageInput" type="text" placeholder="Type your message..." autofocus/>
            
            <input type="file" id="fileUploader" style="display: none;" accept=".txt,.md,.pdf,.doc,.docx, .xlsx, .xls, .csv"/>
            <button id="uploadButton" title="Upload a document">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
            </button>

            <button id="sendButton" title="Send message">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2 11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
            </button>

            <button id="reportButton">VIEW REPORT</button>
            <button id="scheduleButton">SCHEDULE A CALL</button>
        </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- CONFIGURATION ---
      const config = {
        webhookUrl: 'https://inecta.app.n8n.cloud/webhook/chat-handler', // <<< IMPORTANT: REPLACE THIS URL
        scheduleUrl: 'https://meetings.hubspot.com/daniel430/mini-rg-dan-and-sheila'
      };
      const INTRO_MESSAGE = "Hello! I'm an AI assistant from Inecta, here to help with your business requirements and gap analysis. To get started, could you please tell me your name and a bit about your company? You can also upload a document (like an RFP) at any time using the paperclip icon.";
      const INITIAL_TOPICS = [
        {"name": "Company Background", "status": "Not Started"},
        {"name": "Business Scale", "status": "Not Started"},
        {"name": "Finance & Costing", "status": "Not Started"},
        {"name": "Purchasing", "status": "Not Started"},
        {"name": "Core Operations", "status": "Not Started"},
        {"name": "Sales & Logistics", "status": "Not Started"},
        {"name": "Current Pains & Future Needs", "status": "Not Started"},
        {"name": "Reporting & Analytics", "status": "Not Started"}
      ];
      
      // --- DOM ELEMENTS ---
      const elements = {
        chat: document.getElementById('chat'),
        input: document.getElementById('messageInput'),
        sendButton: document.getElementById('sendButton'),
        reportButton: document.getElementById('reportButton'),
        scheduleButton: document.getElementById('scheduleButton'),
        topicTracker: document.getElementById('topicTracker'),
        uploadButton: document.getElementById('uploadButton'),
        fileUploader: document.getElementById('fileUploader'),
        newChatButton: document.getElementById('newChatBtn'),
        attachmentDisplay: document.getElementById('attachmentDisplay'),
      };
      
      // --- LEGAL MODAL ELEMENTS ---
      const legalModal = document.getElementById('legalModal');
      const consentCheckbox = document.getElementById('consentCheckbox');
      const acceptBtn = document.getElementById('acceptBtn');
      const declineBtn = document.getElementById('declineBtn');
      const container = document.querySelector('.container');
      
      // --- STATE MANAGEMENT ---
      let sessionId = null;
      let selectedFile = null;

      // --- CORE FUNCTIONS ---
      function getSessionId(forceNew = false) {
        if (sessionId && !forceNew) return sessionId;

        let storedId = localStorage.getItem('inecta_chat_session_id');
        if (!storedId || forceNew) {
          storedId = crypto.randomUUID();
          localStorage.setItem('inecta_chat_session_id', storedId);
        }
        sessionId = storedId;
        return sessionId;
      }

      function startNewChat() {
        const currentSessionId = getSessionId();
        localStorage.removeItem(`chatHistory_${currentSessionId}`);
        localStorage.removeItem(`topics_${currentSessionId}`);
        
        elements.chat.innerHTML = '';
        elements.topicTracker.innerHTML = '';
        removeAttachment();
        
        initializeSession(true);
      }

      function renderMessage(role, content, save = true) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg ${role}`;
        
        content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        content = content.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
        msgDiv.innerHTML = content.trim(); 
        
        elements.chat.appendChild(msgDiv);
        scrollToBottom();

        if (save) {
          const history = getChatHistory();
          history.push({ role, content });
          saveChatHistory(history);
        }
      }

      function updateTopicTracker(newTopics = []) {
        if (!newTopics || newTopics.length === 0) return;
        
        localStorage.setItem(`topics_${getSessionId()}`, JSON.stringify(newTopics));
        
        elements.topicTracker.innerHTML = '';
        newTopics.forEach(topic => {
          const topicDiv = document.createElement('div');
          topicDiv.className = 'topic-item';
          const statusClass = `status-${topic.status.toLowerCase().replace(/\s+/g, '-')}`;
          topicDiv.classList.add(statusClass);
          topicDiv.textContent = topic.status === 'Completed' ? `✔ ${topic.name}` : topic.name;
          elements.topicTracker.appendChild(topicDiv);
        });
      }
      
      function setUiLoadingState(isLoading) {
        if (isLoading) {
            elements.sendButton.disabled = true;
            elements.uploadButton.disabled = true;
            const indicator = document.createElement('div');
            indicator.id = 'typingIndicator';
            indicator.className = 'msg bot typing-indicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            elements.chat.appendChild(indicator);
            scrollToBottom();
        } else {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
            elements.sendButton.disabled = false;
            elements.uploadButton.disabled = false;
            elements.input.focus();
        }
      }

      function scrollToBottom() {
        elements.chat.scrollTop = elements.chat.scrollHeight;
      }

      // --- LOCAL STORAGE HELPERS ---
      function getChatHistory() {
        const saved = localStorage.getItem(`chatHistory_${getSessionId()}`);
        return saved ? JSON.parse(saved) : [];
      }

      function saveChatHistory(history) {
        localStorage.setItem(`chatHistory_${getSessionId()}`, JSON.stringify(history));
      }

      function loadSessionState() {
        const history = getChatHistory();
        const topicsRaw = localStorage.getItem(`topics_${getSessionId()}`);
        const topics = topicsRaw ? JSON.parse(topicsRaw) : INITIAL_TOPICS;

        elements.chat.innerHTML = '';
        if (history.length > 0) {
            history.forEach(msg => renderMessage(msg.role, msg.content, false));
        } else {
            renderMessage('bot', INTRO_MESSAGE, true);
        }
        updateTopicTracker(topics);
      }
      
      // --- ATTACHMENT UI FUNCTIONS ---
      function updateAttachmentDisplay() {
        if (selectedFile) {
            elements.attachmentDisplay.style.display = 'inline-block';
            elements.attachmentDisplay.innerHTML = `
                <span>${selectedFile.name}</span>
                <button style="margin-left: 10px; cursor:pointer; border:none; background:none;" onclick="removeAttachment()">✖</button>
            `;
        } else {
            elements.attachmentDisplay.style.display = 'none';
            elements.attachmentDisplay.innerHTML = '';
        }
      }
      
      window.removeAttachment = () => {
        selectedFile = null;
        elements.fileUploader.value = '';
        updateAttachmentDisplay();
      };

      // --- LEGAL AGREEMENT FUNCTIONS ---
      function hasUserAcceptedTerms() {
        const acceptance = localStorage.getItem('inecta_legal_acceptance');
        if (!acceptance) return false;
        
        const acceptanceData = JSON.parse(acceptance);
        const daysSinceAcceptance = (Date.now() - acceptanceData.timestamp) / (1000 * 60 * 60 * 24);
        
        // Require re-acceptance after 90 days
        return daysSinceAcceptance < 90;
      }
      
      function showLegalModal() {
        legalModal.classList.add('show');
        container.classList.add('blurred');
        document.body.style.overflow = 'hidden';
      }
      
      function hideLegalModal() {
        legalModal.classList.remove('show');
        container.classList.remove('blurred');
        document.body.style.overflow = '';
      }
      
      async function trackLegalAcceptance() {
        const acceptanceData = {
          timestamp: Date.now(),
          sessionId: getSessionId(),
          userAgent: navigator.userAgent,
          acceptedVersion: '1.0',
          date: new Date().toISOString()
        };
        
        // Store locally
        localStorage.setItem('inecta_legal_acceptance', JSON.stringify(acceptanceData));
        
        // Send to backend for audit trail
        try {
          const formData = new FormData();
          formData.append('action', 'legal_acceptance');
          formData.append('session_id', acceptanceData.sessionId);
          formData.append('timestamp', acceptanceData.timestamp);
          formData.append('accepted_version', acceptanceData.acceptedVersion);
          
          await fetch(config.webhookUrl, {
            method: 'POST',
            body: formData
          });
        } catch (error) {
          console.error('Failed to track acceptance:', error);
        }
        
        return acceptanceData;
      }
      
      // --- LEGAL MODAL EVENT LISTENERS ---
      consentCheckbox.addEventListener('change', (e) => {
        acceptBtn.disabled = !e.target.checked;
        if (e.target.checked) {
          acceptBtn.style.animation = 'pulse-tan 1s ease';
        } else {
          acceptBtn.style.animation = '';
        }
      });
      
      acceptBtn.addEventListener('click', async () => {
        if (!consentCheckbox.checked) return;
        
        acceptBtn.textContent = 'Processing...';
        acceptBtn.disabled = true;
        
        const acceptanceData = await trackLegalAcceptance();
        
        hideLegalModal();
        
        // Initialize the session after acceptance
        initializeSession(false);
        
        // Reset button for next time
        acceptBtn.textContent = 'I Agree';
        consentCheckbox.checked = false;
        acceptBtn.disabled = true;
      });
      
      declineBtn.addEventListener('click', () => {
        if (confirm('Are you sure? You won\'t be able to use the Discovery Assistant without accepting the terms.')) {
          hideLegalModal();
          
          elements.chat.innerHTML = '';
          renderMessage('bot', 'We understand. If you change your mind, please refresh the page to review and accept our terms.', false);
          
          elements.input.disabled = true;
          elements.sendButton.disabled = true;
          elements.uploadButton.disabled = true;
          elements.input.placeholder = 'Please accept terms to continue...';
        }
      });
      
      legalModal.addEventListener('click', (e) => {
        if (e.target === legalModal) {
          const reminder = document.createElement('div');
          reminder.className = 'modal-reminder';
          reminder.textContent = 'Please review and accept the terms to continue';
          document.body.appendChild(reminder);
          
          setTimeout(() => reminder.remove(), 3000);
        }
      });

      // --- UNIFIED SEND FUNCTION ---
      async function sendMessage() {
        const userContent = elements.input.value.trim();
        if (!userContent && !selectedFile) return;

        renderMessage('user', userContent || `<em>Sent file: ${selectedFile.name}</em>`);
        elements.input.value = '';
        setUiLoadingState(true);
        
        const formData = new FormData();
        formData.append('session_id', getSessionId());
        formData.append('message', userContent);
        if (selectedFile) {
          formData.append('fileUploader', selectedFile);
        }

        try {
          const response = await fetch(config.webhookUrl, {
            method: 'POST',
            body: formData,
          });

          if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
          
          const responseData = await response.json();
          renderMessage('bot', responseData.reply);
          
          if (responseData.topics) {
            updateTopicTracker(responseData.topics);
          }
          
          if (responseData.reportUrl) {
            elements.reportButton.onclick = () => window.open(responseData.reportUrl, '_blank');
          }

          if (responseData.isDiscoveryComplete === true) {
            showCompletionControls(true);
          }
          
        } catch (error) {
          console.error('Chat Fetch error:', error);
          renderMessage('bot', 'Sorry, there was an error connecting. Please try again.', false);
        } finally {
          setUiLoadingState(false);
          removeAttachment();
        }
      }

      function showCompletionControls(isComplete) {
        if (isComplete) {
            elements.reportButton.style.display = 'inline-block';
            elements.scheduleButton.style.display = 'inline-block';
            elements.sendButton.style.display = 'none';
            elements.uploadButton.style.display = 'none';
            elements.input.style.display = 'none';
        } else {
            elements.reportButton.style.display = 'none';
            elements.scheduleButton.style.display = 'none';
            elements.sendButton.style.display = 'inline-flex';
            elements.uploadButton.style.display = 'inline-flex';
            elements.input.style.display = 'block';
        }
      }

      // --- INITIALIZATION & EVENT LISTENERS ---
      function initializeSession(isNewChat = false) {
        const currentSessionId = getSessionId(isNewChat);
        const history = getChatHistory();
        
        if (isNewChat || history.length === 0) {
          elements.chat.innerHTML = ''; 
          renderMessage('bot', INTRO_MESSAGE, true);
          updateTopicTracker(INITIAL_TOPICS);
        } else {
          loadSessionState();
        }
        showCompletionControls(false);
      }

      // --- EVENT LISTENERS ---
      elements.sendButton.addEventListener('click', sendMessage);
      elements.input.addEventListener('keypress', (e) => { 
        if (e.key === 'Enter' && !elements.sendButton.disabled) sendMessage(); 
      });
      elements.scheduleButton.addEventListener('click', () => window.open(config.scheduleUrl, '_blank'));
      elements.uploadButton.addEventListener('click', () => elements.fileUploader.click());
      elements.fileUploader.addEventListener('change', (event) => {
        if (event.target.files.length > 0) {
          selectedFile = event.target.files[0];
          updateAttachmentDisplay();
        }
      });
      elements.newChatButton.addEventListener('click', startNewChat);

      // --- INITIAL STARTUP ---
      // Check for legal acceptance first
      if (!hasUserAcceptedTerms()) {
        setTimeout(() => {
          showLegalModal();
        }, 500);
      } else {
        // User has already accepted, proceed normally
        initializeSession();
      }
    });
  </script>
</body>
</html>
