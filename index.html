<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>inecta Food ERP ‚Äì Discovery Chat</title>

  <!-- Core styles come from the original shell :contentReference[oaicite:0]{index=0} -->
  <style>
    /* ‚Ä¶ (all existing CSS kept) ‚Ä¶ */

    /* NEW ‚Äì upload zone */
    #uploadZone {
      border: 2px dashed #667eea;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      color: #667eea;
      font-size: 0.9em;
      margin: 0 20px 15px 20px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #uploadZone.dragover { background: #f0f4ff; }
  </style>
</head>

<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="session-controls">
        <button class="control-button" id="startOverButton">üîÑ Start Over</button>
      </div>
      <h2>Inecta Food ERP Discovery</h2>
      <p>Let's learn about your food business needs</p>

      <!-- progress bar kept from original :contentReference[oaicite:1]{index=1} -->
      <div class="progress-bar" id="progressBar"> ‚Ä¶ </div>
    </div>

    <!-- NEW ‚Äì drag-and-drop / click-to-upload -->
    <div id="uploadZone">üìé Drop RFP / process docs here or click to browse</div>

    <div class="chat-messages" id="chatMessages"></div>

    <div class="typing-indicator" id="typingIndicator">
      <div class="typing-dots"><span></span><span></span><span></span></div>
    </div>

    <div class="chat-input-container">
      <div class="input-wrapper">
        <textarea id="chatInput" class="chat-input" placeholder="Type your response‚Ä¶" rows="1"></textarea>
        <button class="chat-button download-button" id="downloadButton" title="Download Report">üìÑ</button>
        <button class="chat-button" id="sendButton" title="Send message">‚û§</button>
      </div>
    </div>
  </div>

  <script>
    class DiscoveryChat {
      constructor () {
        /* ---------- core state ---------- */
        this.sessionId       = this.generateSessionId();
        this.conversation    = [];
        this.collectedData   = { currentPhase: 'greeting' };
        this.webhookUrl      = 'https://inecta.app.n8n.cloud/webhook/discovery-chat-v11';

        /* ---------- UI refs ---------- */
        this.ui = {
          chatMessages    : document.getElementById('chatMessages'),
          chatInput       : document.getElementById('chatInput'),
          sendButton      : document.getElementById('sendButton'),
          downloadButton  : document.getElementById('downloadButton'),
          typingIndicator : document.getElementById('typingIndicator'),
          progressBar     : document.getElementById('progressBar'),
          startOverButton : document.getElementById('startOverButton'),
          uploadZone      : document.getElementById('uploadZone')
        };

        this.bindEvents();
        this.startChat();
      }

      /* ---------- helpers ---------- */
      generateSessionId () { return 'sess_'+Date.now()+'_'+Math.random().toString(36).slice(2,9); }

      bindEvents () {
        /* send text */
        this.ui.sendButton.onclick = () => this.handleUserText();
        this.ui.chatInput.addEventListener('keypress', e=>{
          if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); this.handleUserText(); }
        });

        /* start-over */
        this.ui.startOverButton.onclick = () => {
          if (confirm('Start a new discovery session?')) location.reload();
        };

        /* upload handling */
        const uz = this.ui.uploadZone;
        uz.onclick = ()=> this.createFileInput().click();
        ['dragenter','dragover'].forEach(ev=> uz.addEventListener(ev,e=>{
          e.preventDefault(); e.stopPropagation(); uz.classList.add('dragover');
        }));
        ['dragleave','drop'].forEach(ev=> uz.addEventListener(ev,e=>{
          e.preventDefault(); e.stopPropagation(); uz.classList.remove('dragover');
        }));
        uz.addEventListener('drop', e=> this.uploadFiles(e.dataTransfer.files));
      }

      createFileInput () {
        const input = document.createElement('input');
        input.type = 'file'; input.multiple = true;
        input.onchange = ()=> this.uploadFiles(input.files);
        return input;
      }

      async uploadFiles (fileList) {
        const files = Array.from(fileList);
        if (!files.length) return;

        this.addMessage(`Uploading ${files.length} document(s)‚Ä¶`, 'system');
        const formData = new FormData();
        formData.append('sessionId', this.sessionId);
        files.forEach(f => formData.append('file', f, f.name));

        try {
          const res = await fetch(this.webhookUrl+'/upload', { method:'POST', body: formData });
          if (!res.ok) throw new Error('Upload failed');
          const data = await res.json();
          this.handleBotResponse(data);
        } catch (err) {
          console.error(err);
          this.addMessage('‚ùå File upload failed, please try again.', 'system');
        }
      }

      /* ---------- text flow ---------- */
      async handleUserText () {
        const text = this.ui.chatInput.value.trim();
        if (!text) return;
        this.addMessage(text,'user');
        this.ui.chatInput.value=''; this.showTyping(true);

        const payload = {
          sessionId        : this.sessionId,
          userMessage      : text,
          conversation     : this.conversation,
          collectedData    : this.collectedData
        };

        try {
          const res = await fetch(this.webhookUrl, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error(res.statusText);
          const data = await res.json();
          this.handleBotResponse(data);
        } catch (err) {
          console.error(err);
          this.addMessage('‚ö†Ô∏è Connection problem, please try again.','system');
        } finally { this.showTyping(false); }
      }

      handleBotResponse (data) {
        if (data.botResponse) this.addMessage(data.botResponse,'bot');
        if (data.conversation)   this.conversation  = data.conversation;
        if (data.collectedData)  this.collectedData = data.collectedData;
        this.updateProgressUI();

        if (data.discoveryComplete) {
          this.ui.downloadButton.style.display='flex';
          this.addMessage('üéâ Discovery complete ‚Äì click üìÑ to download your summary.','system');
        }
      }

      /* ---------- UI helpers ---------- */
      addMessage (txt, sender='bot') {
        const wrap=document.createElement('div');
        wrap.className=`message ${sender}`;
        const inner=document.createElement('div');
        inner.className='message-content'; inner.textContent=txt;
        wrap.appendChild(inner); this.ui.chatMessages.appendChild(wrap);
        this.ui.chatMessages.scrollTop=this.ui.chatMessages.scrollHeight;
      }

      showTyping(flag){ this.ui.typingIndicator.style.display = flag ? 'flex' : 'none'; }

      updateProgressUI () {
        const order = ['greeting','research','industry_questions','pain_points','timeline','complete'];
        const idx = order.indexOf(this.collectedData.currentPhase);
        if (idx<0) return;
        this.ui.progressBar.style.display='block';
        for (let i=1;i<=5;i++){
          const step=document.getElementById('step'+i);
          const line=document.getElementById('line'+i);
          if (!step) continue;
          step.className='step'+(i<=idx?' completed':(i===idx+1?' current':'' ));
          if (line) line.className='step-line'+(i<=idx?' completed':'');
        }
      }

      startChat () {
        this.addMessage("Hi! I'm here to learn about your food business. What's your company name?",'bot');
        this.updateProgressUI();
      }
    }
    window.addEventListener('DOMContentLoaded',()=> new DiscoveryChat());
  </script>
</body>
</html>
