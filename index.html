<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inecta Discovery Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@700&family=Verdana&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Official Inecta Brand Colors */
      --inecta-green: #124030;
      --inecta-teal: #00CCCC;
      --inecta-yellow: #FFD44D;
      --inecta-tan: #DECF9E;
      --dark-grey: #575763;
      --light-grey: #999999;
      
      /* UI Theme Colors */
      --background-light: #F8F8F8;
      --border-color: #EAEAEA;
      --body-text-color: #293036;
      --bot-bubble-bg: #FFFFFF;
      --user-bubble-bg: var(--inecta-green);

      /* Typography from Brand Guide */
      --font-heading: 'Open Sans', sans-serif;
      --font-body: 'Verdana', sans-serif;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: var(--font-body);
      background: var(--background-light);
      color: var(--body-text-color);
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    
    .container {
      width: 100%;
      max-width: 800px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      border-radius: 16px;
      overflow: hidden;
      background: #FFFFFF;
    }
    
    .header {
      padding: 15px 20px;
      background: #FFFFFF;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-family: var(--font-heading);
      font-weight: 700;
      font-size: 20px;
      color: var(--inecta-green);
      letter-spacing: 2px;
    }
    
    #newChatBtn {
      padding: 6px 12px;
      font-size: 12px;
      font-family: var(--font-heading);
      font-weight: 700;
      background-color: var(--light-grey);
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    #newChatBtn:hover {
      background-color: var(--dark-grey);
    }
    
    .topic-tracker { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 8px; 
      padding: 15px 20px;
      justify-content: center;
      border-bottom: 1px solid var(--border-color);
      background: #FFFFFF;
    }
    
    .topic-item { 
      padding: 6px 12px; 
      border-radius: 15px; 
      font-size: 12px; 
      font-family: var(--font-heading);
      font-weight: 700;
      transition: all 0.3s ease; 
      position: relative;
    }
    
    .status-not-started { 
      background-color: #E0E0E0; 
      color: #616161; 
    }
    
    .status-in-progress { 
      background-color: var(--inecta-tan); 
      color: var(--inecta-green); 
      animation: pulse-tan 2s infinite; 
    }
    
    .status-completed { 
      background-color: var(--inecta-green); 
      color: #FFFFFF; 
    }
    
    @keyframes pulse-tan {
      0% { box-shadow: 0 0 0 0 rgba(222, 207, 158, 0.7); }
      70% { box-shadow: 0 0 0 8px rgba(222, 207, 158, 0); }
      100% { box-shadow: 0 0 0 0 rgba(222, 207, 158, 0); }
    }
    
    .chat {
      padding: 30px;
      flex-grow: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      background-color: var(--background-light);
    }
    
    .chat::-webkit-scrollbar { 
      width: 8px; 
    }
    
    .chat::-webkit-scrollbar-track { 
      background: var(--background-light); 
      border-radius: 4px; 
    }
    
    .chat::-webkit-scrollbar-thumb { 
      background-color: #d4d4d4; 
      border-radius: 4px; 
    }
    
    .chat::-webkit-scrollbar-thumb:hover { 
      background-color: var(--dark-grey); 
    }
    
    .msg {
      padding: 12px 18px;
      border-radius: 20px;
      line-height: 1.6;
      max-width: 80%;
      white-space: pre-wrap;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .user {
      background-color: var(--user-bubble-bg);
      color: #FFFFFF;
      border-bottom-right-radius: 5px;
      align-self: flex-end;
    }
    
    .bot {
      background-color: var(--bot-bubble-bg);
      color: var(--body-text-color);
      border: 1px solid var(--border-color);
      border-bottom-left-radius: 5px;
      align-self: flex-start;
    }
    
    .typing-indicator {
      display: none;
      align-items: center;
      padding: 12px 18px;
      background-color: var(--bot-bubble-bg);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      border-bottom-left-radius: 5px;
      align-self: flex-start;
      max-width: 80px;
    }
    
    .typing-indicator.active {
      display: flex;
    }
    
    .typing-indicator span {
      height: 8px; 
      width: 8px; 
      background-color: #BDBDBD;
      border-radius: 50%; 
      display: inline-block; 
      margin: 0 2px;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    
    .typing-indicator span:nth-of-type(2) { 
      animation-delay: -0.2s; 
    }
    
    .typing-indicator span:nth-of-type(3) { 
      animation-delay: -0.4s; 
    }
    
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1.0); }
    }
    
    .input-container {
      padding: 20px;
      border-top: 1px solid var(--border-color);
      background: #FFFFFF;
    }
    
    #attachmentDisplay {
      font-size: 12px;
      font-style: italic;
      margin-bottom: 8px;
      color: var(--dark-grey);
      display: none;
    }
    
    #attachmentDisplay.active {
      display: block;
    }
    
    .input-area {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    #messageInput {
      flex-grow: 1;
      padding: 12px 18px;
      border-radius: 22px;
      border: 1px solid var(--border-color);
      background: var(--background-light);
      color: var(--body-text-color);
      font-size: 16px;
      font-family: var(--font-body);
      transition: all 0.2s ease;
    }
    
    #messageInput:focus {
      outline: none;
      border-color: var(--inecta-teal);
      box-shadow: 0 0 0 2px rgba(0, 204, 204, 0.2);
    }
    
    #messageInput:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .action-button {
      background-color: var(--inecta-teal);
      color: #000000;
      border: none;
      cursor: pointer;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    .action-button:disabled {
      background-color: #BDBDBD;
      cursor: not-allowed;
    }
    
    .action-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    #fileInput {
      display: none;
    }
    
    .error-message {
      background-color: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .success-message {
      background-color: #e8f5e9;
      color: #2e7d32;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .session-info {
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 10px;
      color: #999;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">INECTA</div>
      <button id="newChatBtn">NEW SESSION</button>
    </div>
    
    <div class="topic-tracker" id="topicTracker">
      <!-- Topics will be dynamically updated based on backend response -->
    </div>
    
    <div class="chat" id="chatContainer">
      <div class="msg bot">Welcome to Inecta Discovery Assistant! I'll help gather information about your business needs and requirements. You can also upload documents (PDF, Excel, or text files) to help speed up the process.</div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator">
      <span></span>
      <span></span>
      <span></span>
    </div>
    
    <div class="input-container">
      <div id="attachmentDisplay"></div>
      <div class="input-area">
        <input type="text" id="messageInput" placeholder="Type your message..." />
        <button class="action-button" id="uploadButton" title="Upload document">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
          </svg>
        </button>
        <button class="action-button" id="sendButton" title="Send message">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
      <input type="file" id="fileInput" accept=".pdf,.xlsx,.xls,.csv,.txt,.md" />
    </div>
    <div class="session-info" id="sessionInfo"></div>
  </div>

  <script>
    // Configuration - UPDATE THIS WITH YOUR ACTUAL WEBHOOK URL
    const WEBHOOK_URL = 'https://inecta.app.n8n.cloud/webhook/chat-handler'; // Replace with your actual webhook URL
    
    // State management
    let sessionId = null;
    let isProcessing = false;
    let attachedFile = null;
    
    // DOM elements
    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const uploadButton = document.getElementById('uploadButton');
    const fileInput = document.getElementById('fileInput');
    const attachmentDisplay = document.getElementById('attachmentDisplay');
    const typingIndicator = document.getElementById('typingIndicator');
    const newChatBtn = document.getElementById('newChatBtn');
    const topicTracker = document.getElementById('topicTracker');
    const sessionInfo = document.getElementById('sessionInfo');
    
    // Initialize session
    function initializeSession() {
      // Generate a UUID v4 for the session
      sessionId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
      
      sessionInfo.textContent = `Session: ${sessionId.slice(0, 8)}...`;
      
      // Store in localStorage for persistence
      localStorage.setItem('inecta_session_id', sessionId);
      localStorage.setItem('inecta_session_start', new Date().toISOString());
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Try to restore existing session
      const storedSessionId = localStorage.getItem('inecta_session_id');
      const sessionStart = localStorage.getItem('inecta_session_start');
      
      if (storedSessionId && sessionStart) {
        // Check if session is less than 24 hours old
        const hoursSinceStart = (new Date() - new Date(sessionStart)) / (1000 * 60 * 60);
        if (hoursSinceStart < 24) {
          sessionId = storedSessionId;
          sessionInfo.textContent = `Session: ${sessionId.slice(0, 8)}...`;
        } else {
          initializeSession();
        }
      } else {
        initializeSession();
      }
      
      messageInput.focus();
    });
    
    // Event listeners
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey && !isProcessing) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    uploadButton.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileUpload);
    newChatBtn.addEventListener('click', startNewSession);
    
    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message || isProcessing) return;
      
      isProcessing = true;
      setUIState('disabled');
      
      // Add user message to chat
      addMessage(message, 'user');
      messageInput.value = '';
      
      // Show typing indicator
      showTyping();
      
      try {
        // Prepare the request body
        const requestBody = {
          session_id: sessionId,
          message: message
        };
        
        // Send to backend
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Hide typing indicator
        hideTyping();
        
        // Process response
        processBackendResponse(data);
        
      } catch (error) {
        console.error('Error sending message:', error);
        hideTyping();
        addMessage('Sorry, I encountered an error. Please try again.', 'bot');
        showError('Failed to send message. Please check your connection.');
      } finally {
        isProcessing = false;
        setUIState('enabled');
      }
    }
    
    async function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      // Validate file size (10MB limit)
      if (file.size > 10 * 1024 * 1024) {
        showError('File is too large. Please upload a file smaller than 10MB.');
        return;
      }
      
      isProcessing = true;
      setUIState('disabled');
      
      // Show file attachment
      attachmentDisplay.textContent = `📎 Uploading: ${file.name}...`;
      attachmentDisplay.classList.add('active');
      
      try {
        // Create FormData for file upload
        const formData = new FormData();
        formData.append('session_id', sessionId);
        formData.append('fileUploader', file);
        formData.append('message', `Uploaded file: ${file.name}`);
        
        // Show typing indicator
        showTyping();
        
        // Send to backend
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Hide typing and update attachment display
        hideTyping();
        attachmentDisplay.textContent = `✅ Uploaded: ${file.name}`;
        
        // Show success message
        addMessage(`I've received your file "${file.name}". Let me analyze it...`, 'bot');
        
        // Process the response (which should include document analysis)
        if (data.documentAnalysis) {
          setTimeout(() => {
            processBackendResponse(data);
          }, 1000);
        }
        
        // Clear the file input
        fileInput.value = '';
        
        // Hide attachment display after 3 seconds
        setTimeout(() => {
          attachmentDisplay.classList.remove('active');
          attachmentDisplay.textContent = '';
        }, 3000);
        
      } catch (error) {
        console.error('Error uploading file:', error);
        hideTyping();
        showError('Failed to upload file. Please try again.');
        attachmentDisplay.textContent = `❌ Upload failed: ${file.name}`;
      } finally {
        isProcessing = false;
        setUIState('enabled');
      }
    }
    
    function processBackendResponse(data) {
      // Add bot reply
      if (data.reply) {
        addMessage(data.reply, 'bot');
      }
      
      // Update topics if provided
      if (data.topics && Array.isArray(data.topics)) {
        updateTopics(data.topics);
      }
      
      // Check if discovery is complete
      if (data.isDiscoveryComplete) {
        handleDiscoveryComplete();
      }
      
      // Handle document analysis summary
      if (data.documentSummary) {
        addMessage(data.documentSummary, 'bot');
      }
    }
    
    function updateTopics(topics) {
      topicTracker.innerHTML = '';
      
      topics.forEach(topic => {
        const topicElement = document.createElement('div');
        topicElement.className = 'topic-item';
        
        // Determine status class
        let statusClass = 'status-not-started';
        if (topic.status === 'Completed') {
          statusClass = 'status-completed';
        } else if (topic.status === 'In Progress') {
          statusClass = 'status-in-progress';
        }
        
        topicElement.classList.add(statusClass);
        topicElement.textContent = topic.name;
        
        topicTracker.appendChild(topicElement);
      });
    }
    
    function addMessage(content, sender) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `msg ${sender}`;
      msgDiv.textContent = content;
      chatContainer.appendChild(msgDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    function showTyping() {
      typingIndicator.classList.add('active');
      chatContainer.appendChild(typingIndicator);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    function hideTyping() {
      typingIndicator.classList.remove('active');
    }
    
    function setUIState(state) {
      const disabled = state === 'disabled';
      messageInput.disabled = disabled;
      sendButton.disabled = disabled;
      uploadButton.disabled = disabled;
    }
    
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      chatContainer.appendChild(errorDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      
      // Remove after 5 seconds
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }
    
    function showSuccess(message) {
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.textContent = message;
      chatContainer.appendChild(successDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      
      // Remove after 5 seconds
      setTimeout(() => {
        successDiv.remove();
      }, 5000);
    }
    
    function handleDiscoveryComplete() {
      showSuccess('Discovery process complete! Our team will review the information and contact you soon.');
      
      // Optionally disable further input
      setTimeout(() => {
        addMessage('Thank you for completing the discovery process. A consultant will review your requirements and reach out within 24 hours with next steps.', 'bot');
      }, 1000);
    }
    
    function startNewSession() {
      if (confirm('Start a new session? This will clear the current conversation.')) {
        // Clear localStorage
        localStorage.removeItem('inecta_session_id');
        localStorage.removeItem('inecta_session_start');
        
        // Generate new session
        initializeSession();
        
        // Clear chat
        chatContainer.innerHTML = '<div class="msg bot">Welcome to Inecta Discovery Assistant! I\'ll help gather information about your business needs and requirements. You can also upload documents (PDF, Excel, or text files) to help speed up the process.</div>';
        
        // Clear topics
        topicTracker.innerHTML = '';
        
        // Reset UI
        isProcessing = false;
        setUIState('enabled');
        messageInput.focus();
      }
    }
  </script>
</body>
</html>
